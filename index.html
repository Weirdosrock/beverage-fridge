<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Beverage Fridge</title>
<style>
body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; background:#0f172a; color:#f1f5f9; padding:20px; margin:0; }
h1 { text-align:center; }

.grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(210px,1fr)); gap:14px; }

.card { background:#1e293b; padding:14px; border-radius:14px; box-shadow:0 6px 18px rgba(0,0,0,.3); }

.card img { width:100%; height:120px; object-fit:contain; background:#0b1220; border-radius:10px; margin-bottom:10px; }

.name { font-weight:700; display:flex; justify-content:center; align-items:center; gap:6px; }

.searchIcon {
  font-size:.9rem;
  background:#0b1220;
  padding:4px 6px;
  border-radius:6px;
  border:1px solid rgba(255,255,255,.15);
}

.meta { font-size:.85rem; opacity:.85; text-align:center; margin-top:6px; }

.pillrow { display:flex; justify-content:center; gap:8px; margin-top:8px; }

.status { padding:4px 10px; border-radius:999px; font-size:.8rem; }
.have { background:#16a34a; }
.limited { background:#eab308; color:#111827; }
.out { background:#dc2626; }

.tag { padding:4px 10px; border-radius:999px; background:#0b1220; font-size:.75rem; }

.miniLink {
  display:block;
  text-align:center;
  font-size:.75rem;
  margin-top:10px;
  opacity:.6;
  cursor:pointer;
}

.editor {
  display:none;
  margin-top:8px;
  text-align:center;
}

.editor button {
  margin:4px;
  padding:6px 10px;
  border:none;
  border-radius:999px;
  font-size:.75rem;
  cursor:pointer;
}

.footer { text-align:center; margin-top:16px; font-size:.8rem; opacity:.6; }
</style>
</head>

<body>
<h1>Beverage Fridge</h1>

<div class="grid" id="grid"></div>
<div class="footer" id="updated"></div>

<script>
const SHEET_CSV_URL =
"https://docs.google.com/spreadsheets/d/e/2PACX-1vQzb-W4uPTyGJPj9aZez-MkWa923Ktrs6CDZnlN9VyuRPaYijJhLyPU8xVllMojrzY-iOx0gj5A9nFI/pub?output=csv&gid=0";

const UPDATE_ENDPOINT_URL =
"https://script.google.com/macros/s/AKfycbzDRHY4QHV2Ab1G_8JjvOJ2cTa0HVOgcgexWr6Ly-WGzpTaGU6tE-62OsM-RzBx3bZfHQ/exec";

const UPDATE_TOKEN = "bfridge-7Hn93kLq2pXz-2026";

let drinks = [];

function normalizeStatus(s) {
  s = String(s || "").toLowerCase().trim();
  return ["have","limited","out"].includes(s) ? s : "limited";
}

// Robust CSV parser
function parseCSV(text) {
  const rows = [];
  let row = [];
  let cell = '';
  let inQuotes = false;

  for (let i = 0; i < text.length; i++) {
    const c = text[i];
    const next = text[i+1];

    if (c === '"' && inQuotes && next === '"') {
      cell += '"';
      i++;
      continue;
    }

    if (c === '"') {
      inQuotes = !inQuotes;
      continue;
    }

    if (c === ',' && !inQuotes) {
      row.push(cell);
      cell = '';
      continue;
    }

    if ((c === '\n' || c === '\r') && !inQuotes) {
      if (cell || row.length) {
        row.push(cell);
        rows.push(row);
        row = [];
        cell = '';
      }
      continue;
    }

    cell += c;
  }

  if (cell) {
    row.push(cell);
    rows.push(row);
  }

  const headers = rows[0].map(h => h.toLowerCase());

  return rows.slice(1).map(r => {
    const obj = {};
    headers.forEach((h,i) => obj[h] = (r[i] || "").trim());
    obj.status = normalizeStatus(obj.status);
    return obj;
  });
}

function buildSearch(name, category) {
  return "https://www.google.com/search?q=" +
    encodeURIComponent(name + " " + category);
}

async function updateStatus(key, status) {
  await fetch(UPDATE_ENDPOINT_URL, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      token: UPDATE_TOKEN,
      key: key,
      status: status
    })
  });
}

function render() {
  const grid = document.getElementById("grid");
  grid.innerHTML = "";

  drinks.forEach(d => {
    const card = document.createElement("div");
    card.className = "card";

    const searchUrl = buildSearch(d.name, d.category);

    card.innerHTML = `
      ${d.image ? `<img src="${d.image}" alt="${d.name}">` : ""}
      <div class="name">
        <a href="${searchUrl}" target="_blank">${d.name}</a>
        <a class="searchIcon" href="${searchUrl}" target="_blank">üîç</a>
      </div>
      <div class="meta">${d.brand} ‚Ä¢ ${d.category}</div>
      <div class="pillrow">
        <span class="status ${d.status}">${d.status.toUpperCase()}</span>
        ${d.package ? `<span class="tag">${d.package}</span>` : ""}
      </div>
      <span class="miniLink" onclick="toggleEditor(this)">Status wrong?</span>
      <div class="editor">
        <button class="have" onclick="changeStatus('${d.key}','have')">Have</button>
        <button class="limited" onclick="changeStatus('${d.key}','limited')">Limited</button>
        <button class="out" onclick="changeStatus('${d.key}','out')">Out</button>
      </div>
    `;

    grid.appendChild(card);
  });
}

function toggleEditor(el) {
  const editor = el.nextElementSibling;
  editor.style.display = editor.style.display === "block" ? "none" : "block";
}

async function changeStatus(key, status) {
  const item = drinks.find(d => d.key === key);
  if (!item) return;

  item.status = status;
  render();
  await updateStatus(key, status);
  setTimeout(load, 1200);
}

async function load() {
  const res = await fetch(SHEET_CSV_URL + "&_=" + Date.now());
  const text = await res.text();
  drinks = parseCSV(text);
  render();
  document.getElementById("updated").textContent =
    "Last refreshed: " + new Date().toLocaleString();
}

load();
setInterval(load, 60000);
</script>
</body>
</html>
